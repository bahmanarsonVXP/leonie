name: Deploy to Production

# Ce workflow est optionnel et nécessite Railway CLI
# Railway déploie automatiquement depuis GitHub par défaut
# Utilisez ce workflow seulement si vous voulez un contrôle manuel

on:
  workflow_dispatch:  # Déclenchement manuel uniquement
  # push:
  #   branches: [ production ]  # Décommenter pour auto-deploy

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt pytest

    - name: Run tests
      env:
        SUPABASE_URL: https://test.supabase.co
        SUPABASE_KEY: test-key
        MISTRAL_API_KEY: test-key
        IMAP_EMAIL: test@test.com
        IMAP_PASSWORD: test-password
        SMTP_EMAIL: test@test.com
        SMTP_PASSWORD: test-password
        API_SECRET_KEY: test-secret-key-for-ci-cd
      run: |
        pytest tests/test_document.py -v

  # Ce job est commenté car Railway déploie automatiquement
  # Décommentez si vous voulez utiliser Railway CLI dans GitHub Actions
  #
  # deploy:
  #   needs: test
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/production'
  #
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #
  #   - name: Install Railway CLI
  #     run: npm install -g @railway/cli
  #
  #   - name: Deploy to Railway
  #     env:
  #       RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
  #     run: |
  #       railway link ${{ secrets.RAILWAY_PROJECT_ID }}
  #       railway up --detach
  #
  #   - name: Health check
  #     run: |
  #       sleep 30
  #       curl -f https://votre-app.railway.app/health || exit 1

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Notification succès
      if: needs.test.result == 'success'
      run: |
        echo "✅ Tests passés! Railway déploiera automatiquement."

    - name: Notification échec
      if: needs.test.result == 'failure'
      run: |
        echo "❌ Tests échoués! Railway déploiera quand même (déploiement auto)."
        echo "Vérifiez les tests avant de merger en production."
